<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>UE</title>
    <base href="./">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <style>
      #canvas{
			  background-color: rgba(0,0,0,0.1);
        border: 1px solid orange;
        display: block;
		  }
    </style>
  </head>
  <body>
    <canvas id="canvas" width="800" height="800"></canvas>
    <input type="button" value="toggle paused"
        onclick="createjs.Ticker.paused = !createjs.Ticker.paused;">
    <button id="saveBtn">保存</button>
    <button id="play">reset</button>
    <button id="pause">pause</button>
    <button id="resume">play</button>
    <script>
      let { desktopCapturer, ipcRenderer, remote, webFrame, clipboard } = require('electron');
      window.desktopCapturer = desktopCapturer;
      window.ipcRenderer = ipcRenderer;
      window.remote = remote;
      window.webFrame = webFrame;
      window.clipboard = clipboard;
      window.exec = require('child_process').exec;
      // window.glob = require('glob');
      window.path = require('path');
      window.fs = require('fs');
      // window.loader = require('monaco-loader');
    </script>
    <script src="https://cdn.bootcss.com/EaselJS/1.0.2/easeljs.js"></script>
    <script src="https://cdn.bootcss.com/tweenjs/1.0.2/tweenjs.js"></script>
    <script src="https://cdn.staticfile.org/PreloadJS/1.0.1/preloadjs.js"></script>
    <script>
        canvas = document.getElementById('canvas');
        timeline=new createjs.Timeline();
        stage = new createjs.Stage("canvas");
        //创建一个形状的显示对象
        rect = new createjs.Shape();
        rect.graphics.beginFill("white").drawRect(0, 0, 800, 800);
        //形状实例的设置位置
        rect.x = rect.y = 0;
        //添加形状实例到舞台显示列表
        stage.addChild(rect);
    
        var txt = new createjs.Text("CANVAS", "bold 30px Arial");
        txt.textAlign = "center";
        txt.x = 400;
        txt.y = 30;
        txt.color = 'orange';
        console.log(txt);
        stage.addChild(txt);

        var queue = new createjs.LoadQueue();
        queue.on('complete', function(){
          console.log('complete');
          var img1 = queue.getResult('img1');
          var img2 = queue.getResult('img2');


          // bitmap1 
          var bitmap1 = new createjs.Bitmap(img1);
          
          var bitmapMask = new createjs.Shape();
          bitmapMask.graphics.beginFill('red').drawCircle(150, 150, 100);
          bitmap1.mask = bitmapMask;
          var container = new createjs.Container();
          bitmapMask.shadow = new createjs.Shadow("rgba(0,0,0,0.5)", 5, 5, 10);
          container.addChild(bitmapMask);
          container.addChild(bitmap1);
          
          bitmap1.set({
            scaleX: 0.5,
            scaleY: 0.5,
          })
          container.set({
            x: 250,
            y: 250,
          })

          
          // bitmap2
          var width = img2.width;
          var height = img2.height;
          console.log([width, height]);
          var bitmap2 = new createjs.Bitmap(img2);
          bitmap2.shadow = new createjs.Shadow("rgba(0,0,0,0.5)", 5, 5, 10);
          
          bitmap2.set({
            x: 400,
            y: 400,
            regX: width / 2,
            regY: height / 2,
            cursor : 'pointer',
            rotation: 0,
          })
          stage.addChild(bitmap2);
          stage.addChild(container);
          // tween

          var tween1 = createjs.Tween.get(bitmap2, {loop: -1, bounce: true})
            // .wait(500)
            .to({
              // alpha:1,
              // visible:false,
              rotation: 360,
            }, 1000, createjs.Ease.backInOut)
            .to({
              alpha: 0.8,
            }, 2000, createjs.Ease.linear)
            .to({
              alpha: 1,
              // alpha: 1,
              scaleX: 0.5,
              scaleY: 0.5,
            }, 2000)
            .to({
              scaleX: 1,
              scaleY: 1,
            }, 5000)
            .call(function() {
              console.log('ddddddddddddddddddddddddd');
            });


            createjs.MotionGuidePlugin.install();
            var tween2 = createjs.Tween.get(container, {loop: -1 }).to({guide:{ path:[250,250, 0,0, 200,200, 200,600, 0,0, 100,100, 250, 250] }},5000);

            // timeline
            timeline.addTween(
              tween1,
              tween2,
            );
            
            timeline.setPaused(true);
            timeline.setPosition(0.1);
            
        });
        queue.loadManifest([
          {
            id: 'img1',
            src:'http://cdn.duitang.com/uploads/item/201511/11/20151111162757_BU58a.thumb.700_0.jpeg',
          },
          {
            id: 'img2',
            src:'http://img5.duitang.com/uploads/item/201509/02/20150902213319_wNPYn.thumb.700_0.jpeg',
          }
        ])




        /* var img = new Image();
        img.src='http://img5.duitang.com/uploads/item/201509/02/20150902213319_wNPYn.thumb.700_0.jpeg';
        img.onload=function(){
          var width = img.width;
          var height = img.height;
          console.log([width, height]);
          var bitmap = new createjs.Bitmap(img);
          bitmap.set({
            x: 400,
            y: 400,
            regX: width / 2,
            regY: height / 2,
            cursor : 'pointer',
            rotation: 0,
          })
          stage.addChild(bitmap);
          var bitmapTween = createjs.Tween.get(bitmap, {loop: -1, bounce: true})
            // .wait(500)
            .to({
              alpha:0.8,
              // visible:false,
              rotation: 180,
            }, 1000, createjs.Ease.backInOut)
            .to({
              x: 0,
              y: 0
            }, 2000, createjs.Ease.linear)
            .to({
              alpha: 1,
              scaleX: 0.5,
              scaleY: 0.5,
              x: 400,
              y: 400,
            }, 2000)
            .to({
              scaleX: 1,
              scaleY: 1,
            }, 5000)
            .call(function() {
              console.log('ddddddddddddddddddddddddd');
            });
          
    
          createjs.MotionGuidePlugin.install();
          var target = new createjs.Shape();
          stage.addChild(target);
          target.graphics.ss(1, 'round', 'round').s('#000000').f("orange").dc(0, 0, 6).ef().es();

          var shapeTween = createjs.Tween.get(target, {loop: -1 }).to({guide:{ path:[0,0, 0,200, 200,200, 200,0, 0,0, 100,100, 200, 200] }},5000);

          timeline.addTween(
            bitmapTween,
            shapeTween,
          );
          timeline.setPaused(true)
          function mytick(){
            console.log('tick');
          }
          var myListener = timeline.on('change',mytick);
          setTimeout(function(){
            console.log('not tick');
            timeline.off('change', myListener);
          }, 5000);
        }*/
        //更新阶段将呈现下一帧
        createjs.Ticker.addEventListener("tick", stage);
        
      </script>
      <script>
        var playBtn = document.getElementById('play');
        var pauseBtn = document.getElementById('pause');
        var resumeBtn = document.getElementById('resume');
        playBtn.addEventListener('click',function(){
          timeline.setPosition(0);
          timeline.setPaused(false)
        });
        pauseBtn.addEventListener('click',function(){
          timeline.setPaused(true)
        });
        resumeBtn.addEventListener('click',function(){
          timeline.setPaused(false)
        });
      </script>
      <script>
        var saveBtn = document.getElementById('saveBtn');
        saveBtn.addEventListener('click',function() {
          window['remote'].dialog.showOpenDialog(
            window['remote'].getCurrentWindow(),
            {
              title:'请选择文件目录',
              properties: [ 'openDirectory', 'multiSelections']
            },function(filePaths){
              //this.getCurrentDirFiles(filePaths[0],result);
              
              if(!filePaths){
                return;
              }

              //-----------------------------------

              var frompath = window.path.join(filePaths[0], 'img%d.png').replace(/\\/mig,'/');
              var distpath = window.path.join(filePaths[0], 'video.mp4').replace(/\\/mig,'/');
              var commandStr = '"./ffmpeg/bin/ffmpeg.exe" -r 30 -f image2 -i '+ frompath +' -t 10 -i ./audio/1.mp3 -pix_fmt yuv420p -preset slow -profile:v baseline -q:v 4 ' + distpath;
              // var commandStr = '"./ffmpeg/bin/ffmpeg.exe" -r 30 -f image2 -i '+ frompath +' -t 10 -i ./audio/1.mp3 -vcodec mpeg4 -q:v 4 ' + distpath;
		
              // var commandStr = '"D://Program Files (x86)/UCBrowser/Application/UCBrowser.exe" ww.baidu.com';
              var time = new Date();
              exec(commandStr,{cwd: __dirname},function (err,data,data1) {
                if (err) {
                  console.error(err);
                  return
                }
                console.log(new Date() - time);
                console.log('生成成功');
              })
              return;
              // -------------------------------------------------------------------------------
              var mySaveListener;
              function action() {
                stage.update();
                var base64 = canvas.toDataURL();
                var imgdata =  base64.slice(22)
                fs.writeFile(window.path.join(filePaths[0], 'img'+index+'.png'), imgdata, 'base64', function(err){
                  if(err) {
                    console.error(err);
                    return;
                  }
                });
                
                console.log(index);
                current += 1000 / fps;
                index += 1;
                if(current <= 10000) {
                  timeline.setPosition(current);
                } else {
                  timeline.off('change', mySaveListener);
                  var frompath = window.path.join(filePaths[0], 'img%d.png').replace(/\\/mig,'/');
                  var distpath = window.path.join(filePaths[0], 'video.mp4').replace(/\\/mig,'/');
                  // libx264 本地不行
                  // mpeg4 本地行 网页不行
                  // mpeg1video
                  // var commandStr = '"./ffmpeg/bin/ffmpeg.exe" -r 30 -f image2 -i '+ frompath +' -t 10 -i ./audio/1.mp3 -vcodec mpeg4  -q:v 4 ' + distpath;
                  var commandStr = '"./ffmpeg/bin/ffmpeg.exe" -r 30 -f image2 -i '+ frompath +' -t 10 -i ./audio/1.mp3  -q:v 4 ' + distpath;
		
                  // var commandStr = '"D://Program Files (x86)/UCBrowser/Application/UCBrowser.exe" ww.baidu.com';
                  var time = new Date();
                  exec(commandStr,{cwd: __dirname},function (err,data,data1) {
                    if (err) {
                      console.error(err);
                      return
                    }
                    console.log(new Date() - time);
                    console.log('生成成功');
                  })
                }
              }
              var time = 10000;
              var fps = 30;
              var current = 0;
              var index = 0;

              mySaveListener = timeline.on('change', action);
              timeline.setPosition(0);
              

              console.log(filePaths[0]);
            });
        })
        
      </script>

  </body>
</html>
